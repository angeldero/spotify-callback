<!doctype html>
<html>
  <meta charset="utf-8" />
  <title>Spotify Callback</title>
  <script>
    (function () {
      // Muestra algo por si se abre directo
      document.write('You can close this window.');

      // Recoge tanto ?code=... como #error=...
      const payload = { source: 'spotify-auth' };
      try {
        const q = new URLSearchParams(location.search);
        const h = new URLSearchParams(location.hash.replace(/^#/, ''));
        if (q.get('code')) payload.code = q.get('code');
        if (q.get('state')) payload.state = q.get('state');
        if (h.get('error')) payload.error = h.get('error'); // por compatibilidad
        if (window.opener) {
          // Enviamos al opener (Spotify Web con el userscript)
          window.opener.postMessage(payload, '*');
          window.opener.postMessage(payload, 'https://open.spotify.com');
          console.log('[callback] posted', payload);
        } else {
          console.warn('[callback] No opener; Â¿abriste esta URL a mano?');
        }
      } catch (e) {
        console.error('[callback] Error', e);
      }
    })();
  </script>
</html>
